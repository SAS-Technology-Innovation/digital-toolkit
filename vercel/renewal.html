<!--
/**
 * SAS Digital Toolkit - App Renewal Process Page
 *
 * A password-protected administrative page for managing and comparing app subscriptions
 * during the renewal process. Displays apps by renewal date, cost analysis, and
 * optimization recommendations.
 *
 * @fileoverview App renewal management page for the SAS Digital Toolkit.
 * Accessed via: ?page=renewal parameter in doGet() (Code.js)
 *
 * Features:
 * - Password protection (configurable via Script Properties: RENEWAL_PASSWORD)
 * - Apps sorted by renewal date timeline
 * - Cost analysis and budget tracking
 * - License utilization overview
 * - Renewal decision workflow (Renew, Modify, Replace, Retire)
 * - Export functionality for renewal reports
 *
 * @author SAS Technology Innovation Team
 * @see {@link Code.js#doGet} for URL routing
 */
-->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>SAS Digital Toolkit - Renewal Process</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- SAS Brand Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Icon library -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --sas-red: #a0192a;
      --sas-blue: #1a2d58;
      --sas-yellow: #fabc00;
      --sas-gray: #d8dadb;
      --elementary: #228ec2;
      --middle-school: #a0192a;
      --high-school: #1a2d58;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', Arial, sans-serif;
      background-color: #f8f9fc;
      color: #333;
      line-height: 1.6;
    }

    /* Password Gate */
    .password-gate {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--sas-blue) 0%, #0f1a35 100%);
    }

    .password-container {
      background: white;
      border-radius: 16px;
      padding: 48px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      max-width: 420px;
      width: 90%;
      text-align: center;
    }

    .password-logo {
      width: 80px;
      height: 80px;
      background: var(--sas-blue);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      color: white;
    }

    .password-title {
      font-family: 'Bebas Neue', Arial, sans-serif;
      font-size: 2rem;
      color: var(--sas-blue);
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .password-subtitle {
      color: #666;
      margin-bottom: 32px;
      font-size: 0.95rem;
    }

    .password-input-group {
      position: relative;
      margin-bottom: 24px;
    }

    .password-input {
      width: 100%;
      padding: 16px 48px 16px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .password-input:focus {
      outline: none;
      border-color: var(--sas-blue);
      box-shadow: 0 0 0 3px rgba(26, 45, 88, 0.1);
    }

    .password-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #94a3b8;
    }

    .password-toggle:hover {
      color: var(--sas-blue);
    }

    .password-submit {
      width: 100%;
      padding: 16px;
      background: var(--sas-blue);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .password-submit:hover {
      background: #2a4178;
      transform: translateY(-1px);
    }

    .password-submit:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }

    .password-error {
      color: var(--sas-red);
      font-size: 0.875rem;
      margin-top: 16px;
      display: none;
    }

    .password-error.show {
      display: block;
    }

    /* Main Dashboard */
    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: block;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 48px;
      height: 48px;
      background: var(--sas-blue);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .header-title {
      font-family: 'Bebas Neue', Arial, sans-serif;
      font-size: 1.5rem;
      color: var(--sas-blue);
      letter-spacing: 1px;
    }

    .header-subtitle {
      font-size: 0.8rem;
      color: #666;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--sas-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #2a4178;
    }

    .btn-secondary {
      background: white;
      color: var(--sas-blue);
      border: 2px solid var(--sas-blue);
    }

    .btn-secondary:hover {
      background: var(--sas-blue);
      color: white;
    }

    .btn-danger {
      background: var(--sas-red);
      color: white;
    }

    .btn-danger:hover {
      background: #8a1524;
    }

    /* Stats Cards */
    .stats-section {
      max-width: 1600px;
      margin: 24px auto;
      padding: 0 24px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--sas-blue);
    }

    .stat-card.warning {
      border-left-color: #f59e0b;
    }

    .stat-card.danger {
      border-left-color: var(--sas-red);
    }

    .stat-card.success {
      border-left-color: #10b981;
    }

    .stat-value {
      font-family: 'Bebas Neue', Arial, sans-serif;
      font-size: 2.5rem;
      color: var(--sas-blue);
      line-height: 1;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #666;
      margin-top: 4px;
    }

    /* Filter Section */
    .filter-section {
      max-width: 1600px;
      margin: 24px auto;
      padding: 0 24px;
    }

    .filter-bar {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
    }

    .filter-select, .filter-input {
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
      min-width: 150px;
    }

    .filter-select:focus, .filter-input:focus {
      outline: none;
      border-color: var(--sas-blue);
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px 8px 36px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
    }

    .search-wrapper {
      position: relative;
      flex: 1;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      pointer-events: none;
    }

    /* Timeline Section */
    .timeline-section {
      max-width: 1600px;
      margin: 24px auto;
      padding: 0 24px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-family: 'Bebas Neue', Arial, sans-serif;
      font-size: 1.5rem;
      color: var(--sas-blue);
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Timeline Groups */
    .timeline-group {
      margin-bottom: 24px;
    }

    .timeline-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding: 12px 16px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .timeline-badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .timeline-badge.overdue {
      background: #fee2e2;
      color: #991b1b;
    }

    .timeline-badge.urgent {
      background: #fef3c7;
      color: #92400e;
    }

    .timeline-badge.upcoming {
      background: #dbeafe;
      color: #1e40af;
    }

    .timeline-badge.future {
      background: #d1fae5;
      color: #065f46;
    }

    .timeline-date-range {
      font-weight: 600;
      color: #374151;
    }

    .timeline-count {
      font-size: 0.875rem;
      color: #6b7280;
    }

    /* App Cards */
    .apps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 16px;
    }

    .app-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: all 0.2s;
    }

    .app-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .app-card.selected {
      border: 2px solid var(--sas-blue);
    }

    .app-card-header {
      padding: 16px;
      display: flex;
      gap: 12px;
      border-bottom: 1px solid #f3f4f6;
    }

    .app-logo {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      object-fit: contain;
      background: #f9fafb;
      padding: 4px;
    }

    .app-logo-placeholder {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--sas-blue), var(--sas-red));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.25rem;
    }

    .app-info {
      flex: 1;
      min-width: 0;
    }

    .app-name {
      font-weight: 700;
      color: #111827;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .app-department {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .app-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .app-card-body {
      padding: 16px;
    }

    .app-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .meta-item {
      display: flex;
      flex-direction: column;
    }

    .meta-label {
      font-size: 0.7rem;
      color: #9ca3af;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .meta-value {
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }

    .meta-value.cost {
      color: var(--sas-blue);
    }

    .meta-value.date {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .renewal-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .renewal-status.overdue {
      background: #fee2e2;
      color: #991b1b;
    }

    .renewal-status.urgent {
      background: #fef3c7;
      color: #92400e;
    }

    .renewal-status.upcoming {
      background: #dbeafe;
      color: #1e40af;
    }

    .renewal-status.future {
      background: #d1fae5;
      color: #065f46;
    }

    .app-divisions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 12px;
    }

    .division-tag {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .division-tag.es {
      background: #e0f2fe;
      color: #0369a1;
    }

    .division-tag.ms {
      background: #fce7f3;
      color: #be185d;
    }

    .division-tag.hs {
      background: #ede9fe;
      color: #6d28d9;
    }

    .division-tag.ws {
      background: #d1fae5;
      color: #065f46;
    }

    .app-card-actions {
      padding: 12px 16px;
      background: #f9fafb;
      display: flex;
      gap: 8px;
    }

    .action-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .action-btn.renew {
      background: #d1fae5;
      color: #065f46;
    }

    .action-btn.renew:hover {
      background: #a7f3d0;
    }

    .action-btn.modify {
      background: #fef3c7;
      color: #92400e;
    }

    .action-btn.modify:hover {
      background: #fde68a;
    }

    .action-btn.retire {
      background: #fee2e2;
      color: #991b1b;
    }

    .action-btn.retire:hover {
      background: #fecaca;
    }

    .action-btn.details {
      background: #e0e7ff;
      color: #3730a3;
    }

    .action-btn.details:hover {
      background: #c7d2fe;
    }

    /* No Renewal Date */
    .no-renewal-section {
      margin-top: 32px;
    }

    .no-renewal-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      color: #6b7280;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Bebas Neue', Arial, sans-serif;
      font-size: 1.5rem;
      color: var(--sas-blue);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }

    .modal-close:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Loading & Error States */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: var(--sas-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 16px;
      color: #6b7280;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: #6b7280;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      color: #d1d5db;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: stretch;
      }

      .header-actions {
        justify-content: center;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .apps-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Print Styles */
    @media print {
      .header-actions, .filter-section, .app-card-actions {
        display: none !important;
      }

      .app-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #e5e7eb;
      }
    }

    /* ============================================================ */
    /* ENHANCED FEATURES - Table View, Comparison, AI, etc. */
    /* ============================================================ */

    /* View Toggle Buttons */
    .view-controls {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-group {
      display: flex;
      gap: 0;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }

    .btn-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: white;
      border: none;
      border-right: 1px solid #e5e7eb;
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-toggle:last-child {
      border-right: none;
    }

    .btn-toggle:hover {
      background: #f9fafb;
    }

    .btn-toggle.active {
      background: var(--sas-blue);
      color: white;
    }

    /* Cost Range Filter */
    .cost-range-filter {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px 12px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      min-width: 200px;
    }

    .cost-range-filter label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }

    .cost-range-filter input[type="range"] {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: #e5e7eb;
      border-radius: 2px;
      outline: none;
    }

    .cost-range-filter input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--sas-blue);
      border-radius: 50%;
      cursor: pointer;
    }

    .cost-range-filter input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--sas-blue);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    /* Table View */
    .table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead {
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
    }

    .data-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #374151;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .data-table th:hover {
      background: #f3f4f6;
    }

    .data-table th.sortable {
      position: relative;
      padding-right: 28px;
    }

    .data-table th .sort-arrow {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 2px;
      opacity: 0.3;
    }

    .data-table th.sort-asc .sort-arrow,
    .data-table th.sort-desc .sort-arrow {
      opacity: 1;
      color: var(--sas-blue);
    }

    .data-table th.sort-asc .sort-arrow .arrow-down,
    .data-table th.sort-desc .sort-arrow .arrow-up {
      opacity: 0.3;
    }

    .data-table tbody tr {
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.15s;
    }

    .data-table tbody tr:hover {
      background: #f9fafb;
    }

    .data-table tbody tr.selected {
      background: #eff6ff;
    }

    .data-table td {
      padding: 14px 16px;
      font-size: 0.875rem;
      color: #374151;
    }

    .data-table td.app-name-cell {
      font-weight: 600;
      color: #111827;
    }

    .data-table td.cost-cell {
      font-weight: 600;
      color: var(--sas-blue);
    }

    .data-table td.date-cell {
      white-space: nowrap;
    }

    .data-table .table-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .data-table .table-actions {
      display: flex;
      gap: 4px;
    }

    .data-table .table-action-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    /* Comparison Mode */
    .compare-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 2px solid var(--sas-blue);
      padding: 16px 24px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 99;
    }

    .compare-bar.active {
      display: flex;
    }

    .compare-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .compare-count {
      font-weight: 700;
      color: var(--sas-blue);
      font-size: 1.125rem;
    }

    /* Comparison Modal */
    .comparison-modal {
      max-width: 1200px;
    }

    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .comparison-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e5e7eb;
    }

    .comparison-card h4 {
      font-family: 'Bebas Neue', Arial, sans-serif;
      font-size: 1.25rem;
      color: var(--sas-blue);
      margin-bottom: 16px;
      letter-spacing: 0.5px;
    }

    .comparison-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .comparison-row:last-child {
      border-bottom: none;
    }

    .comparison-label {
      font-size: 0.75rem;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
    }

    .comparison-value {
      font-weight: 600;
      color: #111827;
      font-size: 0.875rem;
      text-align: right;
    }

    .comparison-value.cost {
      color: var(--sas-blue);
      font-size: 1rem;
    }

    /* AI Recommendations Panel */
    .ai-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #8b5cf6;
      display: none;
    }

    .ai-panel.active {
      display: block;
    }

    .ai-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .ai-panel-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Bebas Neue', Arial, sans-serif;
      font-size: 1.25rem;
      color: #8b5cf6;
      letter-spacing: 1px;
    }

    .ai-panel-close {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .ai-panel-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .ai-recommendations {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ai-recommendation {
      padding: 12px 16px;
      background: #f5f3ff;
      border-radius: 8px;
      border-left: 3px solid #8b5cf6;
    }

    .ai-recommendation-type {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #7c3aed;
      margin-bottom: 4px;
    }

    .ai-recommendation-text {
      color: #374151;
      line-height: 1.5;
      font-size: 0.875rem;
    }

    .ai-loading {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      color: #6b7280;
    }

    .ai-loading .spinner {
      width: 24px;
      height: 24px;
      border-width: 2px;
    }

    /* Badge for compare mode */
    .compare-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--sas-blue);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* Responsive updates */
    @media (max-width: 768px) {
      .view-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .cost-range-filter {
        min-width: auto;
      }

      .table-container {
        overflow-x: auto;
      }

      .data-table {
        min-width: 800px;
      }

      .compare-bar {
        flex-direction: column;
        gap: 12px;
      }

      .comparison-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Password Gate -->
  <div id="password-gate" class="password-gate">
    <div class="password-container">
      <div class="password-logo">
        <i data-lucide="shield-check" style="width: 40px; height: 40px;"></i>
      </div>
      <h1 class="password-title">Renewal Process</h1>
      <p class="password-subtitle">Enter the admin password to access the renewal management dashboard</p>
      <form id="password-form">
        <div class="password-input-group">
          <input
            type="password"
            id="password-input"
            class="password-input"
            placeholder="Enter password"
            autocomplete="off"
            required
          >
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
            <i data-lucide="eye" id="eye-icon" style="width: 20px; height: 20px;"></i>
          </button>
        </div>
        <button type="submit" class="password-submit" id="submit-btn">
          Access Dashboard
        </button>
        <p class="password-error" id="password-error">Incorrect password. Please try again.</p>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="dashboard">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="header-brand">
          <div class="header-icon">
            <i data-lucide="calendar-clock" style="width: 24px; height: 24px;"></i>
          </div>
          <div>
            <h1 class="header-title">App Renewal Process</h1>
            <p class="header-subtitle">SAS Digital Toolkit - Subscription Management</p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="exportReport()">
            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
            Export Report
          </button>
          <button class="btn btn-primary" onclick="window.open('https://sas-digital-toolkit.vercel.app', '_blank')">
            <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
            View Toolkit
          </button>
          <button class="btn btn-danger" onclick="logout()">
            <i data-lucide="log-out" style="width: 16px; height: 16px;"></i>
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Stats Section -->
    <section class="stats-section">
      <div class="stats-grid" id="stats-grid">
        <!-- Stats populated by JavaScript -->
      </div>
    </section>

    <!-- Filter Section -->
    <section class="filter-section">
      <div class="filter-bar">
        <div class="search-wrapper">
          <i data-lucide="search" class="search-icon" style="width: 16px; height: 16px;"></i>
          <input type="text" class="search-input" id="search-input" placeholder="Search apps...">
        </div>
        <div class="filter-group">
          <label class="filter-label">Timeline:</label>
          <select class="filter-select" id="timeline-filter">
            <option value="all">All</option>
            <option value="overdue">Overdue</option>
            <option value="30">Next 30 Days</option>
            <option value="60">Next 60 Days</option>
            <option value="90">Next 90 Days</option>
            <option value="none">No Renewal Date</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Division:</label>
          <select class="filter-select" id="division-filter">
            <option value="all">All Divisions</option>
            <option value="whole">Whole School</option>
            <option value="es">Elementary</option>
            <option value="ms">Middle School</option>
            <option value="hs">High School</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Budget:</label>
          <select class="filter-select" id="budget-filter">
            <option value="all">All Budgets</option>
            <option value="Office Of Learning">Office Of Learning</option>
            <option value="IT Operations">IT Operations</option>
            <option value="Communications">Communications</option>
            <option value="Business Office">Business Office</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Sort:</label>
          <select class="filter-select" id="sort-filter">
            <option value="renewal">Renewal Date</option>
            <option value="cost-desc">Cost (High to Low)</option>
            <option value="cost-asc">Cost (Low to High)</option>
            <option value="name">Name (A-Z)</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Timeline Section -->
    <section class="timeline-section" id="timeline-section">
      <div class="section-header">
        <h2 class="section-title">
          <i data-lucide="calendar" style="width: 24px; height: 24px;"></i>
          Renewal Timeline
        </h2>
        <span id="apps-count" style="color: #6b7280; font-size: 0.875rem;"></span>
      </div>
      <div id="timeline-content">
        <!-- Timeline groups populated by JavaScript -->
      </div>
    </section>

    <!-- Loading State -->
    <div id="loading-state" class="loading-container" style="display: none;">
      <div class="spinner"></div>
      <p class="loading-text">Loading subscription data...</p>
    </div>
  </div>

  <!-- App Detail Modal -->
  <div class="modal-overlay" id="app-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">App Details</h3>
        <button class="modal-close" onclick="closeModal()">
          <i data-lucide="x" style="width: 20px; height: 20px;"></i>
        </button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Modal content populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <a id="modal-website" href="#" target="_blank" class="btn btn-primary">
          <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
          Visit Website
        </a>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // CONFIGURATION
    // ============================================================
    // Password is validated server-side via Script Properties
    // Default fallback for local testing only
    const LOCAL_TEST_PASSWORD = 'renewal2024';

    let appData = null;
    let allApps = [];
    let filteredApps = [];
    let isAuthenticated = false;

    // ============================================================
    // INITIALIZATION
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Password form
      document.getElementById('password-form').addEventListener('submit', handlePasswordSubmit);

      // Filters
      document.getElementById('search-input').addEventListener('input', debounce(applyFilters, 300));
      document.getElementById('timeline-filter').addEventListener('change', applyFilters);
      document.getElementById('division-filter').addEventListener('change', applyFilters);
      document.getElementById('budget-filter').addEventListener('change', applyFilters);
      document.getElementById('sort-filter').addEventListener('change', applyFilters);

      // Modal close on overlay click
      document.getElementById('app-modal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
      });

      // ESC key to close modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModal();
      });
    }

    // ============================================================
    // PASSWORD AUTHENTICATION
    // ============================================================
    function handlePasswordSubmit(e) {
      e.preventDefault();
      const password = document.getElementById('password-input').value;
      const submitBtn = document.getElementById('submit-btn');
      const errorEl = document.getElementById('password-error');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';
      errorEl.classList.remove('show');

      // Verify password via server
      if (typeof google !== 'undefined' && typeof google.script !== 'undefined') {
        google.script.run
          .withSuccessHandler(function(isValid) {
            if (isValid) {
              onAuthSuccess();
            } else {
              showPasswordError();
            }
          })
          .withFailureHandler(function(error) {
            console.error('Auth error:', error);
            showPasswordError();
          })
          .verifyRenewalPassword(password);
      } else {
        // Local testing mode
        setTimeout(() => {
          if (password === LOCAL_TEST_PASSWORD) {
            onAuthSuccess();
          } else {
            showPasswordError();
          }
        }, 500);
      }
    }

    function showPasswordError() {
      const submitBtn = document.getElementById('submit-btn');
      const errorEl = document.getElementById('password-error');

      submitBtn.disabled = false;
      submitBtn.textContent = 'Access Dashboard';
      errorEl.classList.add('show');
      document.getElementById('password-input').value = '';
      document.getElementById('password-input').focus();
    }

    function onAuthSuccess() {
      isAuthenticated = true;
      document.getElementById('password-gate').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      loadDashboardData();
    }

    function togglePasswordVisibility() {
      const input = document.getElementById('password-input');
      const icon = document.getElementById('eye-icon');

      if (input.type === 'password') {
        input.type = 'text';
        icon.setAttribute('data-lucide', 'eye-off');
      } else {
        input.type = 'password';
        icon.setAttribute('data-lucide', 'eye');
      }
      lucide.createIcons();
    }

    function logout() {
      isAuthenticated = false;
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('password-gate').style.display = 'flex';
      document.getElementById('password-input').value = '';
      document.getElementById('password-error').classList.remove('show');
    }

    // ============================================================
    // DATA LOADING
    // ============================================================
    function loadDashboardData() {
      document.getElementById('loading-state').style.display = 'flex';
      document.getElementById('timeline-section').style.display = 'none';

      // Check if running in Google Apps Script environment
      if (typeof google !== 'undefined' && typeof google.script !== 'undefined') {
        // Apps Script environment - use server-side function
        google.script.run
          .withSuccessHandler(handleDataLoaded)
          .withFailureHandler(handleDataError)
          .getDashboardData();
      } else {
        // Vercel environment - fetch from Edge Config API
        fetch('/api/renewal-data')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            handleDataLoaded(JSON.stringify(data));
          })
          .catch(error => {
            console.error('Error loading data from Edge Config:', error);
            // Fallback to mock data for local testing
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
              console.log('Using mock data for local testing');
              setTimeout(() => handleDataLoaded(JSON.stringify(getMockData())), 1000);
            } else {
              handleDataError('Failed to load renewal data: ' + error.message);
            }
          });
      }
    }

    function handleDataLoaded(jsonData) {
      try {
        appData = JSON.parse(jsonData);
        if (appData.error) {
          handleDataError(appData.error);
          return;
        }

        // Flatten all apps into a single array
        allApps = getAllApps();
        filteredApps = [...allApps];

        renderStats();
        applyFilters();

        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('timeline-section').style.display = 'block';
        lucide.createIcons();
      } catch (error) {
        handleDataError('Failed to parse data: ' + error.message);
      }
    }

    function handleDataError(error) {
      console.error('Error loading data:', error);
      document.getElementById('loading-state').innerHTML = `
        <div class="empty-state">
          <i data-lucide="alert-circle" class="empty-icon"></i>
          <h3>Error Loading Data</h3>
          <p>${error}</p>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="loadDashboardData()">
            Try Again
          </button>
        </div>
      `;
      lucide.createIcons();
    }

    function getAllApps() {
      const apps = [];
      const seen = new Set();

      const divisions = ['wholeSchool', 'elementary', 'middleSchool', 'highSchool'];
      divisions.forEach(division => {
        if (appData[division] && appData[division].apps) {
          appData[division].apps.forEach(app => {
            if (!seen.has(app.product)) {
              seen.add(app.product);
              apps.push({
                ...app,
                sourceDivision: division
              });
            }
          });
        }
      });

      return apps;
    }

    // ============================================================
    // STATS RENDERING
    // ============================================================
    function renderStats() {
      const now = new Date();

      // Calculate stats
      const overdue = allApps.filter(app => {
        if (!app.renewalDate) return false;
        const date = new Date(app.renewalDate);
        return date < now;
      }).length;

      const next30 = allApps.filter(app => {
        if (!app.renewalDate) return false;
        const date = new Date(app.renewalDate);
        const diff = (date - now) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff <= 30;
      }).length;

      const next90 = allApps.filter(app => {
        if (!app.renewalDate) return false;
        const date = new Date(app.renewalDate);
        const diff = (date - now) / (1000 * 60 * 60 * 24);
        return diff > 30 && diff <= 90;
      }).length;

      const noDate = allApps.filter(app => !app.renewalDate).length;

      const totalSpend = allApps.reduce((sum, app) => {
        if (app.spend === 'Free' || app.spend === 'N/A') return sum;
        const value = parseFloat(app.spend);
        return sum + (isNaN(value) ? 0 : value);
      }, 0);

      const totalLicenses = allApps.reduce((sum, app) => sum + (app.licenses || 0), 0);

      document.getElementById('stats-grid').innerHTML = `
        <div class="stat-card danger">
          <div class="stat-value">${overdue}</div>
          <div class="stat-label">Overdue Renewals</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-value">${next30}</div>
          <div class="stat-label">Due in 30 Days</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${next90}</div>
          <div class="stat-label">Due in 31-90 Days</div>
        </div>
        <div class="stat-card success">
          <div class="stat-value">${allApps.length}</div>
          <div class="stat-label">Total Subscriptions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">$${formatNumber(totalSpend)}</div>
          <div class="stat-label">Total Annual Spend</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${formatNumber(totalLicenses)}</div>
          <div class="stat-label">Total Licenses</div>
        </div>
      `;
    }

    // ============================================================
    // FILTERING
    // ============================================================
    function applyFilters() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const timeline = document.getElementById('timeline-filter').value;
      const division = document.getElementById('division-filter').value;
      const budget = document.getElementById('budget-filter').value;
      const sort = document.getElementById('sort-filter').value;

      const now = new Date();

      filteredApps = allApps.filter(app => {
        // Search filter
        if (searchTerm) {
          const searchFields = [
            app.product,
            app.department,
            app.category,
            app.subject,
            app.budget
          ].join(' ').toLowerCase();

          if (!searchFields.includes(searchTerm)) return false;
        }

        // Timeline filter
        if (timeline !== 'all') {
          const renewalDate = app.renewalDate ? new Date(app.renewalDate) : null;

          if (timeline === 'none') {
            if (renewalDate) return false;
          } else if (timeline === 'overdue') {
            if (!renewalDate || renewalDate >= now) return false;
          } else {
            const days = parseInt(timeline);
            if (!renewalDate) return false;
            const diff = (renewalDate - now) / (1000 * 60 * 60 * 24);
            if (diff < 0 || diff > days) return false;
          }
        }

        // Division filter
        if (division !== 'all') {
          const appDiv = app.division.toLowerCase();
          if (division === 'whole') {
            if (!appDiv.includes('whole') && !appDiv.includes('school-wide')) return false;
          } else if (division === 'es') {
            if (!appDiv.includes('elementary')) return false;
          } else if (division === 'ms') {
            if (!appDiv.includes('middle')) return false;
          } else if (division === 'hs') {
            if (!appDiv.includes('high')) return false;
          }
        }

        // Budget filter
        if (budget !== 'all') {
          if (app.budget !== budget) return false;
        }

        return true;
      });

      // Sort
      filteredApps.sort((a, b) => {
        switch (sort) {
          case 'renewal':
            const dateA = a.renewalDate ? new Date(a.renewalDate) : new Date('2099-12-31');
            const dateB = b.renewalDate ? new Date(b.renewalDate) : new Date('2099-12-31');
            return dateA - dateB;
          case 'cost-desc':
            return parseCost(b.spend) - parseCost(a.spend);
          case 'cost-asc':
            return parseCost(a.spend) - parseCost(b.spend);
          case 'name':
            return a.product.localeCompare(b.product);
          default:
            return 0;
        }
      });

      renderTimeline();
    }

    function parseCost(spend) {
      if (spend === 'Free' || spend === 'N/A') return 0;
      const value = parseFloat(spend);
      return isNaN(value) ? 0 : value;
    }

    // ============================================================
    // TIMELINE RENDERING
    // ============================================================
    function renderTimeline() {
      const now = new Date();
      const container = document.getElementById('timeline-content');

      // Group apps by timeline category
      const groups = {
        overdue: { label: 'Overdue', badge: 'overdue', apps: [] },
        urgent: { label: 'Next 30 Days', badge: 'urgent', apps: [] },
        upcoming: { label: '31-90 Days', badge: 'upcoming', apps: [] },
        future: { label: '90+ Days', badge: 'future', apps: [] },
        noDate: { label: 'No Renewal Date', badge: 'future', apps: [] }
      };

      filteredApps.forEach(app => {
        if (!app.renewalDate) {
          groups.noDate.apps.push(app);
          return;
        }

        const renewalDate = new Date(app.renewalDate);
        const diffDays = (renewalDate - now) / (1000 * 60 * 60 * 24);

        if (diffDays < 0) {
          groups.overdue.apps.push(app);
        } else if (diffDays <= 30) {
          groups.urgent.apps.push(app);
        } else if (diffDays <= 90) {
          groups.upcoming.apps.push(app);
        } else {
          groups.future.apps.push(app);
        }
      });

      // Render groups
      let html = '';

      Object.entries(groups).forEach(([key, group]) => {
        if (group.apps.length === 0) return;

        html += `
          <div class="timeline-group">
            <div class="timeline-header">
              <span class="timeline-badge ${group.badge}">${group.label}</span>
              <span class="timeline-count">${group.apps.length} subscription${group.apps.length !== 1 ? 's' : ''}</span>
            </div>
            <div class="apps-grid">
              ${group.apps.map(app => renderAppCard(app)).join('')}
            </div>
          </div>
        `;
      });

      if (!html) {
        html = `
          <div class="empty-state">
            <i data-lucide="search-x" class="empty-icon"></i>
            <h3>No apps found</h3>
            <p>Try adjusting your filters</p>
          </div>
        `;
      }

      container.innerHTML = html;
      document.getElementById('apps-count').textContent = `${filteredApps.length} of ${allApps.length} apps`;
      lucide.createIcons();
    }

    function renderAppCard(app) {
      const renewalStatus = getRenewalStatus(app.renewalDate);
      const logoHtml = app.logoUrl
        ? `<img src="${app.logoUrl}" alt="${app.product}" class="app-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
           <div class="app-logo-placeholder" style="display:none;">${app.product.charAt(0)}</div>`
        : `<div class="app-logo-placeholder">${app.product.charAt(0)}</div>`;

      const divisionTags = getDivisionTags(app.division);
      const costDisplay = app.spend === 'Free' ? 'Free' : app.spend === 'N/A' ? 'N/A' : `$${formatNumber(parseFloat(app.spend))}`;

      return `
        <div class="app-card" data-product="${app.product}">
          <div class="app-card-header">
            ${logoHtml}
            <div class="app-info">
              <div class="app-name">${app.product}</div>
              <div class="app-department">${app.department || app.budget || 'Uncategorized'}</div>
            </div>
          </div>
          <div class="app-card-body">
            <div class="app-meta">
              <div class="meta-item">
                <span class="meta-label">Annual Cost</span>
                <span class="meta-value cost">${costDisplay}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Licenses</span>
                <span class="meta-value">${app.licenses || 'N/A'}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">License Type</span>
                <span class="meta-value">${app.licenseType || 'N/A'}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Renewal Date</span>
                <span class="meta-value date">
                  ${app.renewalDate ? formatDate(app.renewalDate) : 'Not set'}
                  ${renewalStatus ? `<span class="renewal-status ${renewalStatus.class}">${renewalStatus.label}</span>` : ''}
                </span>
              </div>
            </div>
            <div class="app-divisions">
              ${divisionTags}
            </div>
          </div>
          <div class="app-card-actions">
            <button class="action-btn renew" onclick="handleAction('renew', '${app.product}')">
              <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
              Renew
            </button>
            <button class="action-btn modify" onclick="handleAction('modify', '${app.product}')">
              <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
              Modify
            </button>
            <button class="action-btn retire" onclick="handleAction('retire', '${app.product}')">
              <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
              Retire
            </button>
            <button class="action-btn details" onclick="showAppDetails('${app.product}')">
              <i data-lucide="info" style="width: 14px; height: 14px;"></i>
              Details
            </button>
          </div>
        </div>
      `;
    }

    function getRenewalStatus(dateString) {
      if (!dateString) return null;

      const now = new Date();
      const renewalDate = new Date(dateString);
      const diffDays = (renewalDate - now) / (1000 * 60 * 60 * 24);

      if (diffDays < 0) {
        return { class: 'overdue', label: 'Overdue' };
      } else if (diffDays <= 30) {
        return { class: 'urgent', label: 'Urgent' };
      } else if (diffDays <= 90) {
        return { class: 'upcoming', label: 'Upcoming' };
      }
      return null;
    }

    function getDivisionTags(division) {
      const div = (division || '').toLowerCase();
      let tags = [];

      if (div.includes('whole') || div.includes('school-wide')) {
        tags.push('<span class="division-tag ws">Whole School</span>');
      }
      if (div.includes('elementary')) {
        tags.push('<span class="division-tag es">Elementary</span>');
      }
      if (div.includes('middle')) {
        tags.push('<span class="division-tag ms">Middle School</span>');
      }
      if (div.includes('high')) {
        tags.push('<span class="division-tag hs">High School</span>');
      }

      return tags.join('') || '<span class="division-tag ws">General</span>';
    }

    // ============================================================
    // ACTIONS
    // ============================================================
    function handleAction(action, productName) {
      const app = allApps.find(a => a.product === productName);
      if (!app) return;

      const actionLabels = {
        renew: 'Renew',
        modify: 'Modify',
        retire: 'Retire'
      };

      // For now, show a simple confirmation
      const confirmed = confirm(`Mark "${productName}" for ${actionLabels[action]}?\n\nNote: This action will be logged for the renewal review process.`);

      if (confirmed) {
        // In a full implementation, this would save to the spreadsheet
        alert(`${productName} has been marked for "${actionLabels[action]}".\n\nThe Technology & Innovation team will be notified.`);
      }
    }

    function showAppDetails(productName) {
      const app = allApps.find(a => a.product === productName);
      if (!app) return;

      document.getElementById('modal-title').textContent = app.product;
      document.getElementById('modal-website').href = app.website || '#';

      const renewalStatus = getRenewalStatus(app.renewalDate);
      const costDisplay = app.spend === 'Free' ? 'Free' : app.spend === 'N/A' ? 'N/A' : `$${formatNumber(parseFloat(app.spend))}`;

      document.getElementById('modal-body').innerHTML = `
        <div style="margin-bottom: 24px;">
          ${app.description ? `<p style="color: #374151; line-height: 1.6;">${app.description}</p>` : '<p style="color: #9ca3af; font-style: italic;">No description available</p>'}
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
          <div style="padding: 16px; background: #f9fafb; border-radius: 8px;">
            <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Annual Cost</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--sas-blue);">${costDisplay}</div>
          </div>
          <div style="padding: 16px; background: #f9fafb; border-radius: 8px;">
            <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">License Count</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--sas-blue);">${app.licenses || 'N/A'}</div>
          </div>
        </div>

        <table style="width: 100%; border-collapse: collapse;">
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">License Type</td>
            <td style="padding: 12px 0; font-weight: 600;">${app.licenseType || 'N/A'}</td>
          </tr>
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">Division</td>
            <td style="padding: 12px 0; font-weight: 600;">${app.division || 'N/A'}</td>
          </tr>
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">Department</td>
            <td style="padding: 12px 0; font-weight: 600;">${app.department || 'N/A'}</td>
          </tr>
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">Budget</td>
            <td style="padding: 12px 0; font-weight: 600;">${app.budget || 'N/A'}</td>
          </tr>
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">Renewal Date</td>
            <td style="padding: 12px 0; font-weight: 600;">
              ${app.renewalDate ? formatDate(app.renewalDate) : 'Not set'}
              ${renewalStatus ? `<span class="renewal-status ${renewalStatus.class}" style="margin-left: 8px;">${renewalStatus.label}</span>` : ''}
            </td>
          </tr>
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">Date Added</td>
            <td style="padding: 12px 0; font-weight: 600;">${app.dateAdded ? formatDate(app.dateAdded) : 'N/A'}</td>
          </tr>
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">Audience</td>
            <td style="padding: 12px 0; font-weight: 600;">${app.audience || 'N/A'}</td>
          </tr>
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">SSO Enabled</td>
            <td style="padding: 12px 0; font-weight: 600;">${app.ssoEnabled ? 'Yes' : 'No'}</td>
          </tr>
          <tr>
            <td style="padding: 12px 0; color: #6b7280; font-size: 0.875rem;">Mobile App</td>
            <td style="padding: 12px 0; font-weight: 600;">${app.mobileApp || 'N/A'}</td>
          </tr>
        </table>

        ${app.supportEmail ? `
          <div style="margin-top: 24px; padding: 16px; background: #eff6ff; border-radius: 8px;">
            <div style="font-size: 0.75rem; color: #1e40af; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Support Contact</div>
            <a href="mailto:${app.supportEmail}" style="color: #1e40af; font-weight: 600;">${app.supportEmail}</a>
          </div>
        ` : ''}
      `;

      document.getElementById('app-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
      lucide.createIcons();
    }

    function closeModal() {
      document.getElementById('app-modal').classList.remove('active');
      document.body.style.overflow = '';
    }

    // ============================================================
    // EXPORT
    // ============================================================
    function exportReport() {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];

      // Build CSV content
      let csv = 'Product,Division,Department,Budget,License Type,Licenses,Annual Cost,Renewal Date,Status,SSO,Mobile\n';

      filteredApps.forEach(app => {
        const status = getRenewalStatus(app.renewalDate);
        const cost = app.spend === 'Free' ? '0' : app.spend === 'N/A' ? '' : app.spend;

        csv += [
          `"${app.product}"`,
          `"${app.division}"`,
          `"${app.department || ''}"`,
          `"${app.budget || ''}"`,
          `"${app.licenseType || ''}"`,
          app.licenses || '',
          cost,
          app.renewalDate || '',
          status ? status.label : 'OK',
          app.ssoEnabled ? 'Yes' : 'No',
          app.mobileApp || 'N/A'
        ].join(',') + '\n';
      });

      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `SAS_Renewal_Report_${dateStr}.csv`;
      link.click();
    }

    // ============================================================
    // UTILITIES
    // ============================================================
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (e) {
        return dateString;
      }
    }

    function formatNumber(num) {
      if (isNaN(num)) return '0';
      return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ============================================================
    // MOCK DATA (for local testing)
    // ============================================================
    function getMockData() {
      const today = new Date();
      const mockApps = [
        {
          product: 'Canvas LMS',
          division: 'Whole School',
          department: 'Office Of Learning',
          budget: 'Office Of Learning',
          licenseType: 'Site Licence',
          licenses: 3500,
          spend: '45000',
          renewalDate: new Date(today.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          description: 'Learning management system for course delivery and student engagement.',
          ssoEnabled: true,
          mobileApp: 'Yes',
          enterprise: true,
          website: 'https://canvas.instructure.com'
        },
        {
          product: 'Adobe Creative Cloud',
          division: 'SAS High School, SAS Middle School',
          department: 'Arts',
          budget: 'Office Of Learning',
          licenseType: 'Site Licence',
          licenses: 500,
          spend: '28000',
          renewalDate: new Date(today.getTime() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          description: 'Professional creative tools for design, video, and multimedia.',
          ssoEnabled: true,
          mobileApp: 'Yes',
          website: 'https://www.adobe.com/creativecloud.html'
        },
        {
          product: 'Turnitin',
          division: 'Whole School',
          department: 'Office Of Learning',
          budget: 'Office Of Learning',
          licenseType: 'Site Licence',
          licenses: 2000,
          spend: '12000',
          renewalDate: new Date(today.getTime() + 45 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          description: 'Academic integrity and plagiarism detection platform.',
          ssoEnabled: true,
          mobileApp: 'No',
          website: 'https://www.turnitin.com'
        },
        {
          product: 'Seesaw',
          division: 'SAS Elementary School',
          department: 'Elementary',
          budget: 'Office Of Learning',
          licenseType: 'Division License',
          licenses: 1200,
          spend: '8500',
          renewalDate: new Date(today.getTime() + 120 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          description: 'Student-driven digital portfolios and family communication.',
          ssoEnabled: true,
          mobileApp: 'Yes',
          website: 'https://web.seesaw.me'
        },
        {
          product: 'Kahoot!',
          division: 'Whole School',
          department: 'Office Of Learning',
          budget: 'Office Of Learning',
          licenseType: 'Site Licence',
          licenses: 3000,
          spend: 'Free',
          description: 'Game-based learning platform for interactive quizzes.',
          ssoEnabled: false,
          mobileApp: 'Yes',
          website: 'https://kahoot.com'
        },
        {
          product: 'Notion',
          division: 'SAS High School',
          department: 'Technology',
          budget: 'IT Operations',
          licenseType: 'Inidividual',
          licenses: 50,
          spend: '960',
          renewalDate: new Date(today.getTime() + 200 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          description: 'All-in-one workspace for notes, tasks, and collaboration.',
          ssoEnabled: true,
          mobileApp: 'Yes',
          website: 'https://www.notion.so'
        }
      ];

      return {
        wholeSchool: {
          apps: mockApps.filter(app => app.division.includes('Whole')),
          enterpriseApps: mockApps.filter(app => app.enterprise),
          everyoneApps: [],
          byDepartment: {}
        },
        elementary: {
          apps: mockApps.filter(app => app.division.includes('Elementary')),
          everyoneApps: [],
          byDepartment: {}
        },
        middleSchool: {
          apps: mockApps.filter(app => app.division.includes('Middle')),
          everyoneApps: [],
          byDepartment: {}
        },
        highSchool: {
          apps: mockApps.filter(app => app.division.includes('High')),
          everyoneApps: [],
          byDepartment: {}
        },
        stats: {
          totalApps: mockApps.length
        }
      };
    }
  </script>
</body>
</html>
