<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
    }
    h2 {
      color: #1a2d58;
      margin-top: 0;
    }
    .mode-selection {
      margin: 20px 0;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .mode-option {
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mode-option:hover {
      border-color: #1a2d58;
      background: #fff;
    }
    .mode-option.selected {
      border-color: #1a2d58;
      background: #e8f0fe;
    }
    .mode-option input[type="radio"] {
      margin-right: 10px;
    }
    .mode-description {
      font-size: 12px;
      color: #666;
      margin-left: 28px;
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      box-sizing: border-box;
    }
    .file-upload {
      margin: 15px 0;
    }
    .file-upload input[type="file"] {
      padding: 8px;
    }
    .buttons {
      margin-top: 20px;
      text-align: right;
    }
    button {
      padding: 10px 20px;
      margin-left: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #1a2d58;
      color: white;
    }
    .btn-primary:hover {
      background: #2a3d68;
    }
    .btn-secondary {
      background: #f1f3f4;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e8eaed;
    }
    .progress {
      display: none;
      margin: 15px 0;
      padding: 15px;
      background: #e8f0fe;
      border-radius: 5px;
      text-align: center;
    }
    .progress.show {
      display: block;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a2d58;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .result {
      display: none;
      margin: 15px 0;
      padding: 15px;
      border-radius: 5px;
    }
    .result.show {
      display: block;
    }
    .result.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .result.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .stats {
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h2>üìä Upload CSV/XLSX Data</h2>

  <div class="mode-selection">
    <strong>Update Mode:</strong>
    <div class="mode-option selected" onclick="selectMode('add-update')">
      <input type="radio" name="mode" value="add-update" checked>
      <strong>Add & Update</strong>
      <div class="mode-description">Add new apps and update existing ones (recommended)</div>
    </div>
    <div class="mode-option" onclick="selectMode('update-only')">
      <input type="radio" name="mode" value="update-only">
      <strong>Fill Missing Fields Only</strong>
      <div class="mode-description">Only fill empty fields in existing apps</div>
    </div>
    <div class="mode-option" onclick="selectMode('sync')">
      <input type="radio" name="mode" value="sync">
      <strong>Full Sync</strong>
      <div class="mode-description">‚ö†Ô∏è Add, update, AND deactivate apps not in CSV/XLSX</div>
    </div>
  </div>

  <div class="file-upload">
    <strong>Choose CSV or XLSX file:</strong><br>
    <input type="file" id="csvFile" accept=".csv,.xlsx" onchange="loadFile()">
  </div>

  <div>
    <strong>Or paste CSV data:</strong>
    <textarea id="csvData" placeholder="Paste CSV data here...&#10;Active,product_name,Division,Department,..."></textarea>
  </div>

  <div class="progress" id="progress">
    <div class="spinner"></div>
    <p id="progressText">Processing CSV data...</p>
  </div>

  <div class="result" id="result"></div>

  <div class="buttons">
    <button class="btn-secondary" onclick="google.script.host.close()">Cancel</button>
    <button class="btn-primary" onclick="processUpload()">Upload & Process</button>
  </div>

  <script>
    let selectedMode = 'add-update';
    let fileType = 'csv'; // Track file type
    let xlsxBase64 = null; // Store XLSX file as base64

    function selectMode(mode) {
      selectedMode = mode;
      document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      document.querySelector(`input[value="${mode}"]`).checked = true;
    }

    function loadFile() {
      const file = document.getElementById('csvFile').files[0];
      if (file) {
        const fileName = file.name.toLowerCase();

        if (fileName.endsWith('.xlsx')) {
          // Handle XLSX file - read as binary and convert to base64
          fileType = 'xlsx';
          const reader = new FileReader();
          reader.onload = function(e) {
            const arrayBuffer = e.target.result;
            const bytes = new Uint8Array(arrayBuffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
              binary += String.fromCharCode(bytes[i]);
            }
            xlsxBase64 = btoa(binary);
            document.getElementById('csvData').value = '‚úÖ XLSX file loaded: ' + file.name;
            document.getElementById('csvData').readOnly = true;
          };
          reader.readAsArrayBuffer(file);
        } else if (fileName.endsWith('.csv')) {
          // Handle CSV file - read as text
          fileType = 'csv';
          xlsxBase64 = null;
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('csvData').value = e.target.result;
            document.getElementById('csvData').readOnly = false;
          };
          reader.readAsText(file);
        } else {
          alert('Please upload a CSV or XLSX file.');
        }
      }
    }

    function processUpload() {
      // Show progress
      document.getElementById('progress').classList.add('show');
      document.getElementById('result').classList.remove('show');

      if (fileType === 'xlsx' && xlsxBase64) {
        // Process XLSX file
        document.getElementById('progressText').textContent = 'Processing XLSX file...';
        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onError)
          .processXLSXData(xlsxBase64, selectedMode);
      } else {
        // Process CSV data
        const csvText = document.getElementById('csvData').value.trim();

        if (!csvText || csvText.startsWith('‚úÖ')) {
          alert('Please upload a CSV file or paste CSV data.');
          document.getElementById('progress').classList.remove('show');
          return;
        }

        document.getElementById('progressText').textContent = 'Processing CSV data...';
        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onError)
          .processCSVData(csvText, selectedMode);
      }
    }

    function onSuccess(response) {
      document.getElementById('progress').classList.remove('show');
      const resultDiv = document.getElementById('result');

      if (response.success) {
        resultDiv.className = 'result success show';
        const stats = response.stats;
        resultDiv.innerHTML = `
          <strong>‚úÖ CSV Processing Complete!</strong>
          <div class="stats">
            <div>‚ú® Added: ${stats.added} app(s)</div>
            <div>üîÑ Updated: ${stats.updated} app(s)</div>
            <div>‚ùå Removed/Deactivated: ${stats.removed} app(s)</div>
            <div>‚ö™ Unchanged: ${stats.unchanged} app(s)</div>
            ${stats.errors.length > 0 ? `<div style="color:#856404;margin-top:10px;">‚ö†Ô∏è Errors: ${stats.errors.length}</div>` : ''}
          </div>
        `;
      } else {
        resultDiv.className = 'result error show';
        resultDiv.innerHTML = `
          <strong>‚ùå Processing Failed</strong>
          <div>${response.error}</div>
        `;
      }
    }

    function onError(error) {
      document.getElementById('progress').classList.remove('show');
      const resultDiv = document.getElementById('result');
      resultDiv.className = 'result error show';
      resultDiv.innerHTML = `
        <strong>‚ùå Error</strong>
        <div>${error.message}</div>
      `;
    }
  </script>
</body>
</html>
