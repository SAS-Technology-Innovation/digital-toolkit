# Vercel Deployment Guide

This guide explains how to deploy the SAS Digital Toolkit Dashboard to Vercel while keeping Google Apps Script as the backend data source.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         Vercel                                  │
│  ┌─────────────────┐    ┌─────────────────────────────────┐    │
│  │   public/       │    │   api/                          │    │
│  │   index.html    │───▶│   data.js    ──┐               │    │
│  │   signage.html  │    │   ai.js      ──┼──▶ FRONTEND_KEY│    │
│  └─────────────────┘    └────────────────┼───────────────┘    │
└───────────────────────────────────────────┼────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Google Apps Script                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │   doGet() with ?api=data&key=FRONTEND_KEY               │   │
│  │   - Validates FRONTEND_KEY                              │   │
│  │   - Returns JSON data from Google Sheets                │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Prerequisites

1. **Existing Apps Script Deployment**: Your Google Apps Script must be deployed as a web app
2. **Vercel Account**: Create a free account at [vercel.com](https://vercel.com)
3. **FRONTEND_KEY**: Generate a secure random key (e.g., using `openssl rand -hex 32`)

## Setup Steps

### 1. Configure Apps Script

Add `FRONTEND_KEY` to your Script Properties:

1. Open your Apps Script project: `npm run open`
2. Go to **Project Settings (⚙️) > Script Properties**
3. Add a new property:
   - **Property**: `FRONTEND_KEY`
   - **Value**: Your secure random key (e.g., `a1b2c3d4e5f6...`)

4. **Redeploy** the Apps Script web app to enable the new API endpoints:
   ```bash
   npm run push && npm run deploy
   ```

### 2. Get Your Apps Script URL

Your Apps Script web app URL looks like:
```
https://script.google.com/macros/s/DEPLOYMENT_ID/exec
```

Find this URL in the Apps Script Editor under **Deploy > Manage deployments**.

### 3. Deploy to Vercel

#### Option A: Vercel CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Login to Vercel
vercel login

# Deploy (first time - will create project)
vercel

# Set environment variables
vercel env add FRONTEND_KEY
vercel env add APPS_SCRIPT_URL

# Deploy to production
vercel --prod
```

#### Option B: Vercel Dashboard

1. Go to [vercel.com/new](https://vercel.com/new)
2. Import your GitHub repository
3. Configure environment variables:
   - `FRONTEND_KEY`: Same key you set in Apps Script
   - `APPS_SCRIPT_URL`: Your Apps Script web app URL
4. Deploy

### 4. Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `FRONTEND_KEY` | Shared secret between Vercel and Apps Script | `a1b2c3d4e5f6g7h8...` |
| `APPS_SCRIPT_URL` | Your Apps Script deployment URL | `https://script.google.com/macros/s/.../exec` |
| `RENEWAL_PASSWORD` | Password for the renewal process page | `your-secure-password` |

## API Endpoints

### Vercel Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/data` | GET | Fetches dashboard data from Apps Script |
| `/api/ai` | GET/POST | Proxies AI queries to Apps Script |
| `/api/verify-password` | POST | Verifies renewal page password |

### Apps Script Endpoints

The Apps Script `doGet()` function now supports:

| Parameters | Description |
|------------|-------------|
| `?api=data&key=FRONTEND_KEY` | Returns JSON dashboard data |
| `?api=ai&key=FRONTEND_KEY&query=...&provider=...&appsData=...` | AI query |
| `?api=verify-password&key=FRONTEND_KEY&password=...` | Password verification |

## Local Development

### Test the Build

```bash
# Build the Vercel-compatible frontend
npm run build

# View the generated files
ls -la public/
```

### Run Vercel Dev Server

Create a `.env` file for local development:

```bash
# .env (DO NOT COMMIT)
FRONTEND_KEY=your-frontend-key-here
APPS_SCRIPT_URL=https://script.google.com/macros/s/.../exec
```

Then run:

```bash
npm run vercel:dev
```

## Project Structure

```
digital-toolkit/
├── vercel/                     # Vercel deployment directory
│   ├── api/                    # Vercel serverless functions
│   │   ├── data.js             # Proxies /api/data to Apps Script
│   │   ├── ai.js               # Proxies /api/ai to Apps Script
│   │   └── verify-password.js  # Password verification for renewal page
│   ├── scripts/
│   │   └── build-vercel.js     # Transforms HTML for Vercel
│   ├── public/                 # Generated by build script
│   │   ├── index.html          # Vercel-compatible dashboard
│   │   ├── signage.html        # Vercel-compatible signage
│   │   ├── renewal.html        # Vercel-compatible renewal page
│   │   └── assets/             # Copied from root assets/
│   ├── index.html              # Source: main dashboard
│   ├── signage.html            # Source: digital signage
│   ├── renewal.html            # Source: renewal process page
│   └── vercel.json             # Vercel configuration (in subdirectory)
├── vercel.json                 # Root config pointing to vercel/ directory
├── Code.js                     # Apps Script backend (API only)
├── utilities.js                # Apps Script utilities
├── ai-functions.js             # AI features (Gemini/Claude)
├── data-management.js          # Data validation and enrichment
├── analytics-dashboard.html    # Google Sheets admin dialog
├── csv-upload-dialog.html      # Google Sheets CSV upload dialog
└── assets/                     # Static assets (logos, images)
```

**Note:** Apps Script serves API endpoints only. All HTML pages are served via Vercel.

## Security Notes

1. **Keep FRONTEND_KEY Secret**: Never commit it to your repository
2. **Use Different Keys**: Consider using different keys for production and development
3. **Key Rotation**: Periodically rotate your FRONTEND_KEY
4. **HTTPS Only**: Vercel automatically provides HTTPS

## Troubleshooting

### "Unauthorized" Error

- Verify `FRONTEND_KEY` matches in both Vercel and Apps Script
- Check that you've redeployed Apps Script after adding the key

### "Configuration Error" in Apps Script

- Ensure `SPREADSHEET_ID` and `SHEET_NAME` are set in Script Properties
- Verify the Script Properties are correct

### CORS Errors

The Vercel API functions include CORS headers. If you still see CORS errors:
- Check the browser console for the actual error
- Verify the Apps Script web app access is set to "Anyone"

### Data Not Loading

1. Test the Apps Script API directly:
   ```
   https://script.google.com/macros/s/.../exec?api=data&key=YOUR_KEY
   ```
2. Check the Vercel function logs in the Vercel dashboard
3. Verify environment variables are set correctly

## Dual Deployment

You can run both Apps Script and Vercel deployments simultaneously:

- **Apps Script**: `https://script.google.com/macros/s/.../exec` (original, for internal use)
- **Vercel**: `https://your-project.vercel.app` (new, for public access)

Both use the same Google Sheets data source and Apps Script backend logic.
